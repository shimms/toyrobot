#!/usr/bin/env ruby

DEVELOPMENT=false

begin
   require 'logger'
   require 'fileutils'

   FileUtils.mkdir_p "logs"

   logger = Logger.new('logs/logfile.log', 10, 1024000)

   if DEVELOPMENT
      logger.level = Logger::DEBUG
   else
      logger.level = Logger::WARN
   end

   require './lib/toy_robot.rb'

   if DEVELOPMENT   
      require 'byebug'
   end

   banner = <<-EOS

   ████████╗ ██████╗ ██╗   ██╗    ██████╗  ██████╗ ██████╗  ██████╗ ████████╗
   ╚══██╔══╝██╔═══██╗╚██╗ ██╔╝    ██╔══██╗██╔═══██╗██╔══██╗██╔═══██╗╚══██╔══╝
      ██║   ██║   ██║ ╚████╔╝     ██████╔╝██║   ██║██████╔╝██║   ██║   ██║   
      ██║   ██║   ██║  ╚██╔╝      ██╔══██╗██║   ██║██╔══██╗██║   ██║   ██║   
      ██║   ╚██████╔╝   ██║       ██║  ██║╚██████╔╝██████╔╝╚██████╔╝   ██║   
      ╚═╝    ╚═════╝    ╚═╝       ╚═╝  ╚═╝ ╚═════╝ ╚═════╝  ╚═════╝    ╚═╝   
                                                                           
   EOS

   puts banner

   options = ToyRobot::Cli.parse_options

   if DEVELOPMENT
      puts "Started with options: #{options}"
   end

   world = ToyRobot::World.new(
      options[:width].to_i,
      options[:height].to_i
   )

   robot = ToyRobot::Robot.new(world, ToyRobot::Reducer.new)
   cli = ToyRobot::Cli.new(ToyRobot::Parser.new, robot)

   cli.start_interactive(world)
rescue => e
   # Top level catch all for truely unexpected errors as a line of last defense.

   if DEVELOPMENT
      raise
   else
      logger.fatal e

      puts
      puts "‼ Whoops! Something really unexpected happened, and the program has crashed."
      puts

      exit 1
   end
end